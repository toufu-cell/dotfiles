# Obsidian Research Skill

このスキルは調査リクエストを受けて WebSearch で情報収集し、
結果を Obsidian vault にノートとして自動保存するワークフローを定義する。

---

## 発動条件（常に適用）

以下の表現が含まれたら必ずこのスキルを適用する:
- 「〇〇について調べて」「〇〇を調べて」
- 「〇〇についてまとめて」
- 「〇〇とは何か」「〇〇とは？」
- `/research [トピック]`

**誤発動抑止ルール（ワークフロー自体を起動しない条件）**:

以下のいずれかに該当する場合は、このスキルを**発動させない**（保存ワークフローを一切起動しない）:
- ユーザーの発言にコードブロック（` ``` `）・ファイルパス（`/path/to/file`）・エラーログ語彙（`Error`, `Exception`, `stack trace`, `undefined`, `null`）が含まれる
- ファイルを読む・デバッグする・実装方針を確認する等のコーディング作業の文脈
- ユーザーが明示的に「保存しないで」「メモ不要」「調べるだけでいい」と言っている

> **注意**: 誤発動抑止はスキル「起動前」の判断。一度発動した後は低信頼でも保存継続を優先する（下記「カテゴリ信頼度ルール」参照）。

---

## 除外条件（保存を拒否してユーザーに警告する）

以下が含まれる場合は保存を中断しユーザーに警告する:
- 個人情報（氏名・住所・電話番号・メールアドレス）
- APIキー・パスワード・シークレット・トークン類
- 「社外秘」「機密」「confidential」「secret」とラベルされた情報

---

## カテゴリ判定

→ `category-rules.md` を参照すること

---

## Vault パス

```
VAULT="${HOME}/Library/Mobile Documents/iCloud~md~obsidian/Documents/Obsidian_Vault"
```

## 保存先パスルール

| カテゴリ | パス | frontmatter |
|---------|------|-------------|
| IT用語集 | `$VAULT/IT用語集/{用語名}.md` | `tags`/`kana`/`category` のみ |
| Clippings | `$VAULT/Clippings/{記事タイトル}.md` | 出典メタデータ含む |
| 調査メモ | `$VAULT/調査メモ/{YYYY-MM-DD}-{トピック}.md` | 出典メタデータ含む |

## ファイル命名規則

- **IT用語集**: 日本語 or 英語大文字そのまま（例: `CDN.md`, `形態素解析.md`, `LLM.md`）
- **調査メモ**: 日付プレフィックス + ケバブケース or 日本語（例: `2026-02-19-tmux.md`）
- **Clippings**: 記事タイトルそのまま

---

## topic 正規化ルール（同義語・表記ゆれ重複防止）

ファイル検索・命名前に以下の正規化を行う:

1. 英語略語に統一（例: Large Language Model → LLM、Convolutional Neural Network → CNN）
2. 全角文字→半角変換（英数字のみ。日本語はそのまま）
3. 前後スペース除去
4. ファイル存在確認は小文字化して実施（macOS は case-insensitive だが念のため）
5. よく使われる表記ゆれ対応表（例: Javascript → JavaScript、react → React）

---

## ワークフロー（5フェーズ）

### Phase 1: 除外条件チェック

トピック・検索クエリに機密情報が含まれる場合は即座に中断してユーザーに通知する。
保存は一切行わない。

```
⚠️ 警告: 機密情報（[検出した種類]）が含まれています。
このトピックは Obsidian vault に保存できません。
```

### Phase 2: カテゴリ判定 + 重複確認

1. `category-rules.md` でカテゴリ・信頼度を決定する
2. topic 正規化ルールでファイル名を正規化する
3. 既存ファイルの確認:

```bash
ls "$VAULT/{保存先ディレクトリ}/" | grep -i "{正規化されたトピック名}"
```

既存ファイルの処理:
- **完全同名ファイルが存在** → Read で内容確認 → ユーザーに「上書き/スキップ/別名保存」を確認
- **類似ノートが存在（関連語）** → 新規作成 + `[[既存ノート]]` へのリンクを本文に追加
- **同名なしで新規** → 即座に作成へ進む

### Phase 3: WebSearch で調査

- クエリ1: 「{トピック} とは 仕組み」
- クエリ2: 「{トピック} 使い方 具体例」
- 必要に応じて WebFetch で詳細ページを取得して内容を補強する
- **出典が2件未満の場合 → status を `draft` に強制変更**

### Phase 4: ノート整形

1. `templates.md` の対応テンプレートを適用する
2. `ls "$VAULT/IT用語集/"` で既存ノート一覧を取得し、関連するものを `[[リンク]]` に変換する
3. **IT用語集の場合**: frontmatter は `tags`/`kana`/`category` のみ。出典メタデータは含めない
4. **調査メモ / Clippings の場合**: frontmatter の `retrieved_at` は ISO8601+TZ 形式（例: `2026-02-19T14:30:00+09:00`）で記入し、信頼度・出典数に応じて `status` を設定する（下記ルール参照）

### Phase 5: ファイル保存

**必ず Write ツールを使用する（Bash の echo/cat リダイレクト禁止）。**

**保存前にディレクトリ存在を確認・作成する（Bash で実行）:**
```bash
VAULT="${HOME}/Library/Mobile Documents/iCloud~md~obsidian/Documents/Obsidian_Vault"
mkdir -p "$VAULT/IT用語集"
mkdir -p "$VAULT/Clippings"
mkdir -p "$VAULT/調査メモ"
```

iCloud 同時更新競合対策:
1. 既存ファイルへの上書き時は、書き込み直前にもう一度 Read で内容を再確認する
2. 再確認時に前回読み込み時と内容が異なる（≒ 行数差10%以上 or frontmatter の `retrieved_at` が変化）場合 → `status: draft` + ファイル名に日付サフィックスを追加して退避保存
3. 完了後はパス・生成したリンク一覧・status をユーザーに報告する

完了報告フォーマット（調査メモ / Clippings）:
```
✅ 保存完了
- パス: $VAULT/{カテゴリ}/{ファイル名}.md
- status: {verified|draft}
- 出典数: {N}件
- 関連リンク: [[リンク1]], [[リンク2]]
```

完了報告フォーマット（IT用語集）:
```
✅ 保存完了
- パス: $VAULT/IT用語集/{用語名}.md
- category: {カテゴリ名}
- 参照元: [[調査メモ名]]（あれば）
- 関連リンク: [[リンク1]], [[リンク2]]
```

---

## status 決定ルール（一元定義）

**status は調査メモ・Clippings にのみ適用する。IT用語集には status フィールドを含めない。**

**status は「出典数」と「カテゴリ判定信頼度」の組み合わせで決定する。**

| 出典数 | カテゴリ判定信頼度 | status | 対象 |
|--------|-----------------|--------|------|
| 2件以上 | HIGH | `verified` | 調査メモ / Clippings |
| 2件以上 | MEDIUM/LOW | `draft` | 調査メモ / Clippings |
| 1件 | 任意 | `draft` | 調査メモ / Clippings |
| 0件 | 任意 | `draft` | 調査メモ / Clippings |
| - | - | （なし） | IT用語集 |

**例外: Clippings（URL直指定）**
- URL を直接指定し、かつ WebFetch でページ内容の取得に成功した場合 → `verified`
- WebFetch 失敗・アクセス不可の場合 → `draft`

**IT用語集の出典管理**:
- frontmatter に出典メタデータは含めない
- 調査メモから生成された場合は本文末尾に `- 参照元：[[調査メモ名]]` を追加して紐づける

**発動後は保存継続を優先する**:
スキルが一度発動した後は、カテゴリ判定が低信頼であっても保存を中断しない。
低信頼の場合は `調査メモ/ + status: draft` に退避して保存する。

---

## 既存ノート更新ポリシー

| 状況 | 対応 |
|-----|------|
| 完全同名ファイルが存在 | Read で確認 → ユーザーに「上書き/スキップ/別名保存」を確認 |
| 類似ノートが存在（関連語） | 新規作成 + `[[既存ノート]]` へのリンクを本文に追加 |
| 同名なしで新規 | 即座に作成 |

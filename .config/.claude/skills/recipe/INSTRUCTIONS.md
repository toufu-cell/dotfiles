# Recipe スキル

材料リストからレシピを考案し、Obsidian vault の `レシピ/` フォルダに保存するスキル。

## Vault パス設定

```
VAULT="${HOME}/Library/Mobile Documents/iCloud~md~obsidian/Documents/Obsidian_Vault"
RECIPE_DIR="$VAULT/レシピ"
```

---

## ワークフロー

### Phase 0: 安全チェック

入力された食材に危険なものが含まれていないか確認する。

#### 生成中断（危険が高く安全な調理法がない）

以下の食材・条件が含まれる場合は **エラーを表示してレシピ生成を中断する**:

- フグ（素人調理は法律・安全上禁止）
- 野生キノコ（毒キノコの判別が困難）
- 鶏肉・豚肉の生食前提レシピ（食中毒リスク）
- その他、素人が安全に調理できない食材

エラー表示例:
```
⚠️ 安全上の理由でレシピを生成できません
- 理由: {危険な食材・理由}
- 代替提案: {安全な代替食材や方法があれば提示}
```

#### 注意喚起のみ（加熱で安全に対応可能）

以下の食材は **レシピに加熱温度・時間の注意を明記する**:

- 鶏肉・豚肉・ひき肉（中心温度75℃以上・豚は63℃以上）
- 生卵（サルモネラ菌対策の注意）
- その他、十分な加熱が必要な食材

---

### Phase 1: 材料の解析

入力された食材を以下のカテゴリに分類する:

- **メイン食材**: 料理の主役となる食材（肉・魚・野菜の主要なもの）
- **サブ食材**: メインを補う食材（野菜・豆腐など）
- **調味料**: 塩・醤油・みりんなど（入力にあれば）

分類結果をもとに、どのような料理が作れるか検討する。

---

### Phase 2: 料理候補の提示

分析した食材から 2〜3 種類の料理候補を考案してユーザーに提示する。

提示フォーマット:
```
以下の料理が作れます。どれにしますか？

1. {料理名1} - {難易度} / 約{調理時間}分
   {一行説明}

2. {料理名2} - {難易度} / 約{調理時間}分
   {一行説明}

3. {料理名3} - {難易度} / 約{調理時間}分
   {一行説明}

番号を入力してください（「全部」または "all" で全候補を保存）:
```

#### 非対話フォールバック

- **無応答・`--full-auto` 実行時**: 第1候補を自動採用
- **`$ARGUMENTS` に "全部" または "all" が含まれる場合**: 全候補を保存

---

### Phase 3: レシピ詳細の作成

選ばれた料理の詳細レシピを作成する。

#### レシピ構成

```markdown
## 材料（{人数}人分）

| 食材 | 分量 |
|------|------|
| {食材1} | {分量1} |
| {食材2} | {分量2} |
...

## 下準備

1. {下準備手順1}
2. {下準備手順2}

## 作り方

1. {手順1}
2. {手順2}
...

## コツ・ポイント

- {コツ1}
- {コツ2}

## アレンジ提案

- {アレンジ1}
- {アレンジ2}

## 栄養メモ（任意）

{主要な栄養素や健康上のポイント}
```

#### WebSearch の利用条件

以下の場合のみ WebSearch / WebFetch を利用する:

- 危険な調理法に関する安全情報が必要な場合
- 珍しい・馴染みのない食材の調理法が不明な場合
- ユーザーが「根拠を示して」「調べて」と明示した場合

通常のレシピ生成では WebSearch は使用しない。

---

### Phase 4: Obsidian 保存

#### ディレクトリ確認・作成

```bash
VAULT="${HOME}/Library/Mobile Documents/iCloud~md~obsidian/Documents/Obsidian_Vault"
RECIPE_DIR="$VAULT/レシピ"
mkdir -p "$RECIPE_DIR"
```

#### ファイル命名規則

- 形式: `{料理名}.md`
- 禁止文字 `/\:*?"<>|` は `_` に変換
- 例: `鶏肉の照り焼き.md`, `豚バラと白菜の鍋.md`

#### 重複ファイルの処理

同名ファイルが存在する場合:

1. 既存ファイルを Read で読み込んで内容を確認
2. ユーザーに選択肢を提示:
   ```
   「{料理名}.md」はすでに存在します。どうしますか？
   1. 上書き
   2. スキップ（保存しない）
   3. 別名保存（{料理名}_{YYYYMMDD-HHMMSS}.md）
   ```
3. **非対話フォールバック**: 無応答時は別名保存（`{料理名}_{YYYYMMDD-HHMMSS}.md`）を自動選択

#### iCloud 競合対策

上書き保存する場合:
1. Write の直前に既存ファイルを再 Read して最新状態を確認
2. 内容に差分がある場合はユーザーに確認してから保存

#### frontmatter テンプレート

```yaml
---
tags:
  - レシピ
  - {主要食材タグ}      # 例: 鶏肉, 豚肉, 野菜
  - {料理ジャンルタグ}  # 例: 和食, 中華, 洋食, イタリアン
  - {調理法タグ}        # 例: 炒め物, 煮物, 焼き物, 揚げ物, 蒸し物
dish: "{料理名}"
difficulty: "{初級|中級|上級}"
cook_time: {調理時間（分）}
servings: {人数}
main_ingredients:
  - "{食材1}"
  - "{食材2}"
input_ingredients:
  - "{ユーザーが入力した食材1}"
  - "{ユーザーが入力した食材2}"
allergens:
  - "{該当するアレルゲン（なければ空配列 []）}"
source_type: "generated"    # generated | web
source_urls: []             # WebSearch 利用時のみ記入（generated なら空配列）
retrieved_at: ""            # WebSearch 利用時のみ ISO8601+TZ 形式で記入
created: {YYYY-MM-DD}
updated: {YYYY-MM-DD}
status: verified
---
```

#### タグ付けルール

| カテゴリ | 例 |
|----------|-----|
| 主要食材 | `鶏肉`, `豚肉`, `牛肉`, `魚`, `豆腐`, `野菜`, `卵` |
| 料理ジャンル | `和食`, `洋食`, `中華`, `イタリアン`, `フレンチ`, `エスニック` |
| 調理法 | `炒め物`, `煮物`, `焼き物`, `揚げ物`, `蒸し物`, `生食`, `スープ` |
| 特徴 | `時短`, `作り置き`, `お弁当`, `ヘルシー`, `ボリューム` |

---

## 完了報告フォーマット

```
✅ レシピ保存完了
- 料理名: {料理名}
- パス: $VAULT/レシピ/{ファイル名}.md
- 使用食材: {N}種類
- 調理時間: 約{N}分
```

---

## エラーハンドリング

| 状況 | 対応 |
|------|------|
| 材料が空・不明な場合 | 「材料を入力してください」と案内 |
| 危険食材が含まれる場合 | Phase 0 の手順でエラー表示・中断 |
| Vault ディレクトリが存在しない場合 | `mkdir -p` で作成してから保存 |
| 書き込みエラー | エラー内容を表示してユーザーに報告 |

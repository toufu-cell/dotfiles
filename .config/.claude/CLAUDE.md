# Global Claude Code Instructions

このファイルは全てのClaude Codeセッションに適用される個人的なルールと設定を定義します。

## 言語設定

- **レスポンス言語**: 日本語
- **説明スタイル**: 明確で簡潔に、必要に応じて詳細を提供
- **技術用語**: 英語の技術用語をそのまま使用し、必要に応じて日本語で補足

## コーディングスタイル

### インデント
- **基本**: 4スペースを使用
- タブ文字は使用しない
- エディタの設定と一貫性を保つ

### 命名規則
- **変数・関数**: camelCase (例: `getUserData`, `isValid`)
- **クラス**: PascalCase (例: `UserService`, `DataManager`)
- **定数**: UPPER_SNAKE_CASE (例: `MAX_RETRY_COUNT`, `API_BASE_URL`)
- **ファイル名**: kebab-case または PascalCase (プロジェクトの規約に従う)

### コードの品質
- 明確で読みやすいコードを優先
- 適切なコメントを追加（複雑なロジックや意図が不明瞭な箇所）
- DRY原則（Don't Repeat Yourself）を意識
- 関数は単一責任の原則に従う

## 開発ワークフロー

### Git
- コミットメッセージは明確に（何を、なぜ変更したか）
- 小さく頻繁にコミット
- ブランチ名は説明的に（例: `feature/user-auth`, `fix/api-timeout`）

### エラーハンドリング
- 適切なエラーハンドリングを実装
- エラーメッセージはユーザーフレンドリーに
- ログ出力は開発とプロダクションで適切に分ける

## Claude Code 固有の設定

### ツールの使用
- ファイル操作は専用ツール（Read, Edit, Write）を優先
- 並列実行可能な操作は並列で実行
- 大きな変更の前に計画を提示

### タスク管理
- 複雑なタスクはTodoWriteで管理
- タスクの進捗をリアルタイムで更新
- 完了したタスクは即座にマーク

### コミュニケーション
- 変更内容を明確に説明
- セキュリティやパフォーマンスの懸念点があれば指摘
- 必要に応じてファイルパスと行番号で参照（例: `file.ts:123`）

---

## カスタマイズ用セクション

以下のセクションは必要に応じて追加・編集してください。

### よく使う技術スタック
<!-- 例:
- フロントエンド: React, Next.js
- バックエンド: Node.js, Express
- データベース: PostgreSQL, Redis
- インフラ: Docker, AWS
-->

### プロジェクト固有のルール
<!-- プロジェクト横断的に適用したいルールを記述 -->

### 個人的な好み
<!-- その他の個人的な開発の好みや注意点 -->

## フロントエンド開発ガイドライン

フロントエンドUI（React, Vue, HTML/CSS等）を生成・修正する際は、
`~/.claude/skills/design/` のデザインガイドラインを参照すること。

### 参照すべきスキル
- `SKILL.md` - 概要とクイックチェックリスト
- `anti-patterns.md` - AIっぽいUIを避けるためのパターン集
- `typography.md` - フォント選択ルール（Inter, Roboto禁止）
- `theme.md` - カラーパレット（紫グラデーション禁止、ティール/エメラルド推奨）
- `background.md` - 背景デザインルール
- `motion.md` - アニメーション原則

### 必ず確認すること
- Inter, Roboto, Open Sans フォントを使用しない
- 紫グラデーション (`#667eea` → `#764ba2`) を使用しない
- 汎用青ボタン (`#007bff`) をそのまま使用しない
- 推奨カラー: ティール (`#0D9488`) / エメラルド (`#10B981`)

## Codex CLI レビュー連携

コードや方針について重要な判断が必要な場面では、Codex CLI にレビュー・議論を依頼する。
tmux-agent スキル（`~/.claude/skills/tmux-agent/SKILL.md`）を参照して操作すること。

### 発動条件（必須ルール）

以下の2つのタイミングで **必ず** Codex に相談する。例外なし。

#### ルール1: ファイルを編集する前

Edit / Write ツールを使ってコードを変更する **前に**、Codex に以下を相談する:
- 何を変更するか
- なぜその変更が必要か
- どのように実装するか

**例外（Codex 不要）**: typo 修正、コメントの修正、空白調整など、判断の余地がない1行の明らかな変更のみ

#### ルール2: 方針を決定した後

ユーザーからのタスクを受けて実装方針を決めたら、**実装に着手する前に** Codex にその方針をレビューしてもらう:
- 決めた方針の妥当性
- 見落としているリスクや代替案
- 実装順序の確認

### 連携モード

**常に対話モード（tmux pane 経由）を使用する。`codex exec` は使用禁止。**

対話モードは文脈を維持した複数ラウンドの議論が可能で、レビュー用途に最適。

#### 操作手順（必ずこの手順に従うこと）

すべての複雑なロジックは `~/.claude/skills/tmux-agent/bin/` のスクリプトに外部化されている。
Claude Code からは `bash スクリプト名` の1行で呼び出すこと（改行・リダイレクトを含むインラインスクリプトは禁止）。

1. **pane セットアップ**: codex pane がなければ作成・起動する（pane index は `/tmp/tmux-codex-pane.txt` に自動保存される）
   ```bash
   bash ~/.claude/skills/tmux-agent/bin/tmux-pane-setup.sh
   ```

2. **送信前スナップショット取得**（pane index はファイルから自動読み取り）:
   ```bash
   bash ~/.claude/skills/tmux-agent/bin/tmux-snapshot.sh
   ```

3. **プロンプト送信（必ず別々の Bash 呼び出しで実行）**:
   pane ファイルの検証・読み取りはスクリプト内部で行われる。
   ```bash
   # Bash 呼び出し1: テキスト入力
   bash ~/.claude/skills/tmux-agent/bin/tmux-send-text.sh "レビュー依頼のテキスト"
   ```
   ```bash
   # Bash 呼び出し2: Enter で送信確定（必ず別の Bash 呼び出し！）
   bash ~/.claude/skills/tmux-agent/bin/tmux-send-enter.sh
   ```

4. **完了待機ポーリング → 出力キャプチャ**（pane index はファイルから自動読み取り）:
   ```bash
   bash ~/.claude/skills/tmux-agent/bin/tmux-poll.sh
   ```

5. **差分抽出**: Claude Code 側で送信プロンプト（› で始まる行）と応答（• で始まる行）を識別する

**禁止事項**:
- `codex exec` を使ってはならない。必ず上記の tmux pane 対話手順を踏むこと。
- 改行を含む複数行スクリプトや `>` リダイレクトを Bash ツールに直接書かないこと。必ず bin/ のスクリプトを使うこと。

### レビュー依頼のフォーマット

Codex に送るプロンプトには以下を含める:

```
[レビュー依頼]
## 背景
（何をしようとしているか）

## 選択肢
（検討中のアプローチを列挙）

## 判断ポイント
（特に意見が欲しい点）

## コードコンテキスト
（関連するファイルパスや該当コードの抜粋）
```

### ワークフロー（反復レビューループ）

```
┌─ 1. レビュー依頼 ─────────────────────────────────┐
│  Codex に方針 or コード変更のレビューを送信        │
└──────────────────────────┬──────────────────────────┘
                           ▼
┌─ 2. Codex 回答を受け取る ─────────────────────────┐
│  指摘事項を確認し、ユーザーに共有                  │
└──────────────────────────┬──────────────────────────┘
                           ▼
              ┌─ Medium/High 指摘あり？ ─┐
              │                          │
           Yes│                       No │
              ▼                          ▼
┌─ 3. 指摘に基づき修正 ─┐  ┌─ 5. 最終確認依頼 ──────────────────────┐
│  コードを修正する      │  │  Codex に「全指摘解消の確認」を送信    │
└───────────┬────────────┘  │  Codex から「問題なし」の応答を得る    │
            ▼               └──────────────────┬─────────────────────┘
┌─ 4. 再レビュー依頼 ──┐                      ▼
│  修正内容を Codex に  │  ┌─ 6. 完了 ──────────────────────────────┐
│  送信して再検証依頼   │  │  Codex の承認応答をユーザーに共有し    │
│ （同じ pane に追加）  │  │  最終報告                              │
└──────────┬───────────┘  └─────────────────────────────────────────┘
           │
           └───────── 2 に戻る（Medium/High が0になるまで）
```

**具体的な手順:**

1. ユーザーに「Codex にレビューを依頼します」と報告
2. tmux pane で Codex にレビュー依頼を送信
3. ポーリングで完了を待ち、Codex の回答をキャプチャ
4. 回答に指摘事項（Medium/High）がある場合:
   a. 指摘内容をユーザーに共有
   b. 指摘に基づきコードを修正（Edit/Write ツール）
   c. 修正内容を Codex に再送信して再検証を依頼
   d. 再びポーリング → 回答キャプチャ → 指摘確認
   e. **Medium/High 指摘が0になるまで繰り返す**
5. Medium/High 指摘がなくなったら、**Codex に最終確認を依頼する**:
   a. 以下のフォーマットで最終確認を送信
   b. ポーリングで Codex の応答を待つ
   c. Codex から「全て解決済み / 問題なし」の明示的な応答を確認する
   d. **Codex が新たな指摘を返した場合は、手順 4 に戻る**
6. Codex の承認応答をユーザーに共有し、最終報告する

**ループ上限**: 最大5回の反復。5回で解消しない場合は途中経過をユーザーに報告し判断を委ねる。
**早期エスカレーション**: 同一の指摘（同じ指摘IDまたは同じ内容の Medium/High）が2回連続で再発した場合は、ループを中断してユーザーに判断を委ねる。

**再レビュー依頼のフォーマット**:
```
[再レビュー Round {N}]
前回指摘への対応:
- {指摘ID} {Severity}({指摘の要約}): {対応結果 fixed/won't-fix} — {変更概要 or 理由}
- {指摘ID} {Severity}({指摘の要約}): {対応結果} — {変更概要 or 理由}
変更ファイル: {ファイルパス}
再検証して、まだ問題が残っているか確認してほしい。
```

**最終確認依頼のフォーマット**（Medium/High 指摘が0になった後に送信）:
```
[最終確認]
全ての Medium/High 指摘に対応しました。
対応済み指摘の一覧:
- {指摘ID} {Severity}({指摘の要約}): {対応結果} — {変更概要}
- ...

残存する未対応指摘はありません。
全ての問題が解消されたことを確認してください。問題なければ「承認」と回答してください。
```

**最終確認の判定ルール**:
- Codex の応答に「承認」「問題なし」「LGTM」「OK」等の肯定的な表現が含まれていれば完了とする
- Codex が新たな Medium/High 指摘を返した場合は、手順 4 の修正ループに戻る
- Codex が応答しない・不明瞭な場合は、もう一度最終確認を送信する（最大2回まで。それでも不明瞭な場合はユーザーに判断を委ねる）

### 注意事項

- **`codex exec` は絶対に使わない** — 必ず tmux pane 対話で行う
- Codex の回答は参考意見として扱い、最終判断はユーザーに委ねる
- Codex とのやりとりは常にユーザーに可視化する（隠さない）
- 反復レビュー中も各ラウンドの結果をユーザーに逐次報告する
- Low の指摘はループ継続の対象外（任意対応）。Medium/High のみループ対象

## Obsidian Vault統合

Claude Codeセッションでは、以下のObsidian vaultを参照できます:

- **Vaultパス**: `${HOME}/Library/Mobile Documents/iCloud~md~obsidian/Documents/Obsidian_Vault`
- **主要なディレクトリ**:
  - `IT用語集/` - 技術用語の定義と解説
  - `参考論文/` - 研究・技術論文のメモ
  - `Clippings/` - Webクリッピング
  - その他のプロジェクトノート

**使用方法**:
- 必要に応じてObsidianノートの内容を参照してコンテキストを提供
- 技術用語や概念の説明が必要な場合はIT用語集を確認
- プロジェクト関連の背景情報はObsidianノートから取得可能

### Research スキル（自動発動）

「調べて」「まとめて」「〇〇とは」という表現が含まれたら、
`~/.claude/skills/obsidian-research/SKILL.md` を参照してリサーチ＆保存ワークフローを実行すること。

**保存先**:
- URL 指定 → `Clippings/`
- IT/技術系の用語定義 → `IT用語集/`
- その他 → `調査メモ/`（YYYY-MM-DD プレフィックス付き）

**誤発動抑止ルール**:
- 「調べて」「まとめて」であっても、コーディング作業の文脈（ファイルを読む・デバッグする等）では発動しない
- ユーザーが明示的に「保存しないで」「メモ不要」と言った場合は発動しない
- コードのエラー調査・ライブラリの使い方確認など、回答だけで完結する文脈でも発動しない

**機密情報除外ルール**:
- 個人情報・APIキー・「社外秘」「機密」とラベルされた情報は保存拒否
- 保存前にユーザーへ警告する

**コマンド**: `/research [トピック名]`
